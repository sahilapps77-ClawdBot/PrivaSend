<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PrivaSend â€” PII Detection & Redaction</title>
<style>
  /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    min-height: 100vh;
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
    color: #e0e0e0;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2rem 1rem;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
  }

  /* Animated background orbs */
  body::before, body::after {
    content: '';
    position: fixed;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.3;
    z-index: 0;
    animation: float 12s ease-in-out infinite alternate;
  }
  body::before {
    width: 500px; height: 500px;
    background: #7c3aed;
    top: -10%; left: -10%;
  }
  body::after {
    width: 400px; height: 400px;
    background: #06b6d4;
    bottom: -10%; right: -10%;
    animation-delay: -6s;
  }
  @keyframes float {
    0%   { transform: translate(0, 0) scale(1); }
    100% { transform: translate(60px, 40px) scale(1.1); }
  }

  /* â”€â”€ Glass Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .glass {
    position: relative;
    z-index: 1;
    background: rgba(255, 255, 255, 0.06);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  /* â”€â”€ Auth Styles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .auth-bar {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .auth-bar button {
    padding: 0.5rem 1rem;
    font-size: 0.85rem;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #fff;
    cursor: pointer;
    transition: all 0.2s;
  }
  .auth-bar button:hover {
    background: rgba(255, 255, 255, 0.2);
  }
  .user-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(6, 182, 212, 0.2);
    border: 1px solid rgba(6, 182, 212, 0.4);
    border-radius: 8px;
    font-size: 0.85rem;
  }
  .user-info svg {
    width: 18px;
    height: 18px;
  }

  /* â”€â”€ Login Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .login-modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(5px);
    z-index: 200;
    display: none;
    align-items: center;
    justify-content: center;
  }
  .login-modal.open {
    display: flex;
  }
  .login-box {
    background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 2.5rem;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }
  .login-box h2 {
    margin-bottom: 1.5rem;
    text-align: center;
    font-size: 1.5rem;
    background: linear-gradient(135deg, #a78bfa, #06b6d4);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .login-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }
  .login-tab {
    flex: 1;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    transition: all 0.2s;
  }
  .login-tab.active {
    background: rgba(124, 58, 237, 0.3);
    border-color: rgba(124, 58, 237, 0.5);
    color: #fff;
  }
  .login-form {
    display: none;
  }
  .login-form.active {
    display: block;
  }
  .login-input {
    width: 100%;
    padding: 0.875rem 1rem;
    margin-bottom: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: #fff;
    font-size: 0.95rem;
  }
  .login-input:focus {
    outline: none;
    border-color: #7c3aed;
  }
  .login-btn {
    width: 100%;
    padding: 0.875rem;
    background: linear-gradient(135deg, #7c3aed, #06b6d4);
    border: none;
    border-radius: 10px;
    color: #fff;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .login-btn:hover {
    opacity: 0.9;
  }
  .google-btn {
    width: 100%;
    padding: 0.875rem;
    background: #fff;
    border: none;
    border-radius: 10px;
    color: #333;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  .google-btn svg {
    width: 20px;
    height: 20px;
  }
  .divider {
    text-align: center;
    margin: 1.5rem 0;
    position: relative;
  }
  .divider::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    height: 1px;
    background: rgba(255, 255, 255, 0.1);
  }
  .divider span {
    background: #1a1a2e;
    padding: 0 1rem;
    position: relative;
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.85rem;
  }

  /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .page-layout {
    display: none;
    gap: 1.5rem;
    width: 100%;
    max-width: 1320px;
    z-index: 1;
    position: relative;
    align-items: flex-start;
  }
  .page-layout.authenticated {
    display: flex;
  }
  .container {
    flex: 1;
    min-width: 0;
    z-index: 1;
    position: relative;
  }
  .sidebar {
    width: 340px;
    flex-shrink: 0;
    position: sticky;
    top: 2rem;
    z-index: 1;
  }

  header {
    text-align: center;
    margin-bottom: 2rem;
    z-index: 1;
    position: relative;
  }

  h1 {
    font-size: 2.2rem;
    font-weight: 700;
    background: linear-gradient(135deg, #a78bfa, #06b6d4);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.4rem;
  }

  header p {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.95rem;
  }

  .card {
    padding: 2rem;
    margin-bottom: 1.5rem;
  }

  /* â”€â”€ Labels & Hints â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 0.6rem;
  }

  .hint {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.4);
    margin-bottom: 1rem;
  }

  /* â”€â”€ Textarea â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  textarea {
    width: 100%;
    min-height: 160px;
    background: rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: #e0e0e0;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 0.9rem;
    line-height: 1.6;
    padding: 1rem;
    resize: vertical;
    transition: border-color 0.2s;
  }
  textarea:focus {
    outline: none;
    border-color: rgba(167, 139, 250, 0.5);
    box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.1);
  }
  textarea::placeholder {
    color: rgba(255, 255, 255, 0.25);
  }

  /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .btn-row {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.2rem;
  }

  button {
    flex: 1;
    padding: 0.85rem 1.5rem;
    border: none;
    border-radius: 12px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: linear-gradient(135deg, #7c3aed, #6d28d9);
    color: #fff;
  }
  .btn-primary:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
  }
  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-secondary {
    background: rgba(255, 255, 255, 0.08);
    color: #e0e0e0;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  .btn-secondary:hover:not(:disabled) {
    background: rgba(255, 255, 255, 0.12);
  }

  .btn-success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: #fff;
  }
  .btn-success:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
  }

  .btn-link {
    background: none;
    border: none;
    color: rgba(167, 139, 250, 0.7);
    font-size: 0.8rem;
    padding: 0.3rem 0.5rem;
    cursor: pointer;
    flex: 0;
  }
  .btn-link:hover { color: #a78bfa; }

  /* â”€â”€ Loading spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .spinner {
    display: inline-block;
    width: 18px; height: 18px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    margin-right: 0.5rem;
    vertical-align: middle;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Review Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .review-panel { display: none; }
  .review-panel.visible { display: block; }

  .category-section {
    margin-bottom: 1rem;
    border-left: 3px solid rgba(255, 255, 255, 0.1);
    padding-left: 1rem;
  }

  .category-header {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    padding: 0.5rem 0;
    cursor: pointer;
  }
  .category-header input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #7c3aed;
  }
  .category-header .cat-name {
    font-weight: 600;
    font-size: 0.9rem;
    color: #e0e0e0;
  }
  .category-header .cat-count {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.4);
    background: rgba(255, 255, 255, 0.08);
    padding: 0.15rem 0.5rem;
    border-radius: 10px;
  }
  .category-header .confidence-indicator {
    font-size: 0.65rem;
    padding: 0.15em 0.4em;
    border-radius: 4px;
    margin-left: auto;
  }
  .confidence-indicator.high { background: rgba(16,185,129,0.25); color: #6ee7b7; }
  .confidence-indicator.medium { background: rgba(245,158,11,0.25); color: #fcd34d; }
  .confidence-indicator.mixed { background: rgba(139,92,246,0.25); color: #c4b5fd; }

  .entity-list {
    padding-left: 1.5rem;
    margin-top: 0.3rem;
  }

  .entity-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.35rem 0;
    font-size: 0.85rem;
    border-left: 3px solid transparent;
    padding-left: 0.5rem;
    margin-left: -0.5rem;
  }
  .entity-item.high { border-left-color: #6ee7b7; }
  .entity-item.medium { border-left-color: #fcd34d; }
  .entity-item input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: #7c3aed;
  }
  .entity-item .entity-value {
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    color: #fca5a5;
    word-break: break-all;
  }
  .entity-item .entity-meta {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.35);
    margin-left: auto;
  }

  /* Preference controls */
  .pref-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 1.2rem 0;
    padding: 0.6rem 0.8rem;
    background: rgba(255, 255, 255, 0.04);
    border-radius: 10px;
    font-size: 0.8rem;
  }
  .pref-controls label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8rem;
    font-weight: normal;
    text-transform: none;
    letter-spacing: normal;
    color: rgba(255, 255, 255, 0.5);
    margin: 0;
  }
  .pref-controls input[type="checkbox"] {
    width: 14px;
    height: 14px;
    accent-color: #7c3aed;
  }

  /* â”€â”€ Results Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .results { display: none; }
  .results.visible { display: block; }

  .stats-bar {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 1.2rem;
    flex-wrap: wrap;
  }

  .stat {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .stat-value {
    font-size: 1.6rem;
    font-weight: 700;
    background: linear-gradient(135deg, #a78bfa, #06b6d4);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .stat-label {
    font-size: 0.75rem;
    color: rgba(255,255,255,0.4);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Redacted text display */
  .redacted-output {
    background: rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 1rem;
    font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
    font-size: 0.9rem;
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
    margin-bottom: 1.2rem;
    min-height: 60px;
  }

  /* PII tag pill */
  .pii-tag {
    display: inline;
    padding: 0.15em 0.5em;
    border-radius: 6px;
    font-size: 0.82rem;
    font-weight: 600;
    letter-spacing: 0.03em;
  }

  /* Color palette for PII types */
  .pii-EMAIL           { background: rgba(239, 68, 68, 0.25); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }
  .pii-PHONE           { background: rgba(59, 130, 246, 0.25); color: #93c5fd; border: 1px solid rgba(59,130,246,0.3); }
  .pii-SSN             { background: rgba(245, 158, 11, 0.25); color: #fcd34d; border: 1px solid rgba(245,158,11,0.3); }
  .pii-CREDIT_CARD     { background: rgba(236, 72, 153, 0.25); color: #f9a8d4; border: 1px solid rgba(236,72,153,0.3); }
  .pii-PERSON          { background: rgba(16, 185, 129, 0.25); color: #6ee7b7; border: 1px solid rgba(16,185,129,0.3); }
  .pii-ADDRESS         { background: rgba(139, 92, 246, 0.25); color: #c4b5fd; border: 1px solid rgba(139,92,246,0.3); }
  .pii-ORGANIZATION    { background: rgba(14, 165, 233, 0.25); color: #7dd3fc; border: 1px solid rgba(14,165,233,0.3); }
  .pii-LOCATION        { background: rgba(20, 184, 166, 0.25); color: #5eead4; border: 1px solid rgba(20,184,166,0.3); }
  .pii-API_KEY         { background: rgba(239, 68, 68, 0.25); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }
  .pii-CREDENTIAL      { background: rgba(239, 68, 68, 0.25); color: #fca5a5; border: 1px solid rgba(239,68,68,0.3); }
  .pii-default         { background: rgba(148, 163, 184, 0.25); color: #cbd5e1; border: 1px solid rgba(148,163,184,0.3); }

  .source-badge {
    display: inline-block;
    padding: 0.15em 0.5em;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.03em;
  }
  .source-regex    { background: rgba(245,158,11,0.25); color: #fcd34d; border: 1px solid rgba(245,158,11,0.3); }
  .source-presidio { background: rgba(59,130,246,0.25); color: #93c5fd; border: 1px solid rgba(59,130,246,0.3); }

  /* â”€â”€ AI Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.75);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .modal.visible { display: flex; }

  .modal-content {
    width: 90%;
    max-width: 500px;
    padding: 2rem;
    max-height: 90vh;
    overflow-y: auto;
  }
  .modal-content h3 {
    font-size: 1.2rem;
    margin-bottom: 1.2rem;
    background: linear-gradient(135deg, #a78bfa, #06b6d4);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .modal-content select,
  .modal-content input[type="text"],
  .modal-content input[type="password"] {
    width: 100%;
    padding: 0.8rem 1rem;
    background: rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: #e0e0e0;
    font-size: 0.9rem;
    margin-bottom: 1rem;
  }
  .modal-content select:focus,
  .modal-content input:focus {
    outline: none;
    border-color: rgba(167, 139, 250, 0.5);
  }

  .modal-content textarea {
    min-height: 100px;
    margin-bottom: 1rem;
  }

  .modal-content details {
    margin-bottom: 1rem;
  }
  .modal-content summary {
    cursor: pointer;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 0.5rem;
  }

  /* â”€â”€ AI Response Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .ai-response-panel { display: none; }
  .ai-response-panel.visible { display: block; }

  .ai-response-content {
    background: rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    padding: 1rem;
    font-size: 0.9rem;
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
  }

  /* â”€â”€ Notification Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: rgba(16, 185, 129, 0.9);
    color: #fff;
    padding: 0.8rem 1.5rem;
    border-radius: 10px;
    font-size: 0.9rem;
    font-weight: 600;
    z-index: 2000;
    opacity: 0;
    transition: all 0.3s ease;
  }
  .toast.visible {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* â”€â”€ Error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .error-msg {
    background: rgba(239, 68, 68, 0.15);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 10px;
    padding: 0.8rem 1rem;
    color: #fca5a5;
    font-size: 0.9rem;
    margin-top: 1rem;
    display: none;
  }
  .error-msg.visible { display: block; }

  /* â”€â”€ Sidebar: How It Works â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .info-card { padding: 1.5rem; }
  .info-card h2 {
    font-size: 1rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(255,255,255,0.5);
    margin-bottom: 1rem;
    text-align: center;
  }

  .info-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .info-list li {
    display: flex;
    align-items: flex-start;
    gap: 0.6rem;
    font-size: 0.8rem;
    color: rgba(255,255,255,0.6);
    padding: 0.5rem 0;
    line-height: 1.5;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .info-list li:last-child { border-bottom: none; }
  .info-list .step-num {
    flex-shrink: 0;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 700;
    background: rgba(139,92,246,0.25);
    color: #c4b5fd;
    border: 1px solid rgba(139,92,246,0.3);
  }

  .info-divider {
    border: none;
    border-top: 1px solid rgba(255,255,255,0.08);
    margin: 1rem 0;
  }

  .info-features {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
  }
  .feature-tag {
    font-size: 0.7rem;
    padding: 0.3rem 0.6rem;
    border-radius: 15px;
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.5);
    border: 1px solid rgba(255,255,255,0.08);
  }

  /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  footer {
    text-align: center;
    margin-top: 1rem;
    color: rgba(255,255,255,0.25);
    font-size: 0.8rem;
    z-index: 1;
    position: relative;
  }
  footer a { color: rgba(167, 139, 250, 0.6); text-decoration: none; }
  footer a:hover { color: #a78bfa; }

  /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 1100px) {
    .page-layout { flex-direction: column; align-items: center; }
    .sidebar { width: 100%; max-width: 800px; position: static; }
  }
  @media (max-width: 600px) {
    body::before, body::after { display: none; }
    body { padding: 1rem 0.5rem; }
    h1 { font-size: 1.6rem; }
    header p { font-size: 0.82rem; }
    .card { padding: 1rem; border-radius: 14px; }
    .glass { border-radius: 14px; }
    .btn-row { flex-direction: column; }
    .stats-bar { gap: 1rem; }
    textarea { min-height: 120px; font-size: 0.82rem; padding: 0.8rem; border-radius: 10px; }
    .redacted-output { font-size: 0.78rem; padding: 0.8rem; border-radius: 10px; line-height: 1.6; }
    .pii-tag { font-size: 0.72rem; padding: 0.1em 0.35em; }
    button { padding: 0.75rem 1rem; font-size: 0.9rem; }
    label { font-size: 0.78rem; }
    .container, .sidebar { max-width: 100%; overflow: hidden; }
    .modal-content { padding: 1.5rem; }
  }
</style>
</head>
<body>

<!-- Auth Bar -->
<div class="auth-bar" id="auth-bar">
  <div class="user-info" id="user-info" style="display: none;">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
    <span id="user-email"></span>
  </div>
  <button id="btn-login" onclick="openLoginModal()">Login</button>
  <button id="btn-logout" onclick="handleLogout()" style="display: none;">Logout</button>
</div>

<!-- Login Modal -->
<div class="login-modal" id="login-modal">
  <div class="login-box">
    <h2>Welcome to PrivaSend</h2>
    <div class="login-tabs">
      <button class="login-tab active" onclick="switchTab('login')" id="tab-login">Login</button>
      <button class="login-tab" onclick="switchTab('signup')" id="tab-signup">Sign Up</button>
    </div>
    
    <!-- Login Form -->
    <form class="login-form active" id="form-login" onsubmit="handleLogin(event)">
      <input type="email" class="login-input" id="login-email" placeholder="Email" required>
      <input type="password" class="login-input" id="login-password" placeholder="Password" required>
      <button type="submit" class="login-btn">Login</button>
    </form>
    
    <!-- Signup Form -->
    <form class="login-form" id="form-signup" onsubmit="handleSignup(event)">
      <input type="email" class="login-input" id="signup-email" placeholder="Email" required>
      <input type="password" class="login-input" id="signup-password" placeholder="Password" required minlength="6">
      <button type="submit" class="login-btn">Sign Up</button>
    </form>
    
    <div class="divider"><span>or</span></div>
    
    <button class="google-btn" onclick="handleGoogleAuth()">
      <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continue with Google
    </button>
  </div>
</div>

<header>
  <h1>PrivaSend</h1>
  <p>Detect, review, and redact personally identifiable information</p>
</header>

<div class="page-layout" id="page-layout">

  <!-- LEFT: Main content -->
  <div class="container">
    <!-- Input Card -->
    <div class="glass card">
      <label for="input-text">Input Text</label>
      <div class="file-upload-row" style="margin-bottom: 0.75rem;">
        <input type="file" id="file-input" accept=".pdf,.docx,.txt,.png,.jpg,.jpeg,.tiff" style="display: none;">
        <button class="btn-secondary" id="btn-upload" style="flex: 0 0 auto; padding: 0.6rem 1rem; font-size: 0.85rem;">
          ðŸ“Ž Upload File
        </button>
        <span id="file-name" style="font-size: 0.8rem; color: rgba(255,255,255,0.5); margin-left: 0.5rem;"></span>
      </div>
      <textarea id="input-text" placeholder="Paste text containing PII here, or upload a file...&#10;&#10;Example: My name is John Smith, email john@example.com, SSN 123-45-6789&#10;&#10;Supported: PDF, DOCX, TXT, PNG, JPG"></textarea>
      <div class="btn-row">
        <button class="btn-primary" id="btn-analyze">Analyze PII</button>
        <button class="btn-secondary" id="btn-clear">Clear</button>
      </div>
      <div class="error-msg" id="error-msg"></div>
    </div>

    <!-- Review Panel (hidden until analysis) -->
    <div class="glass card review-panel" id="review-panel">
      <label>Review Detected PII</label>
      <p class="hint">High-confidence items are pre-selected. Uncheck items you don't want to redact.</p>

      <div id="categories-container"></div>

      <div class="pref-controls">
        <label>
          <input type="checkbox" id="persist-prefs">
          Remember my preferences
        </label>
        <button class="btn-link" id="btn-reset-prefs">Reset to defaults</button>
      </div>

      <div class="btn-row">
        <button class="btn-primary" id="btn-redact-only">Redact Only</button>
        <button class="btn-success" id="btn-send-ai">Send to AI</button>
      </div>
    </div>

    <!-- Results Panel (after redaction) -->
    <div class="results" id="results-panel">
      <div class="glass card">
        <label>Redacted Output</label>
        <div class="stats-bar">
          <div class="stat">
            <span class="stat-value" id="stat-count">0</span>
            <span class="stat-label">PII Redacted</span>
          </div>
          <div class="stat">
            <span class="stat-value" id="stat-time">0</span>
            <span class="stat-label">ms</span>
          </div>
        </div>
        <div class="redacted-output" id="redacted-output"></div>
        <div class="btn-row">
          <button class="btn-secondary" id="btn-copy">Copy to Clipboard</button>
          <button class="btn-secondary" id="btn-new">Start Over</button>
        </div>
      </div>
    </div>

    <!-- AI Response Panel -->
    <div class="glass card ai-response-panel" id="ai-response-panel">
      <label>AI Response</label>
      <div class="ai-response-content" id="ai-response-content"></div>
      <div class="btn-row" style="margin-top: 1rem;">
        <button class="btn-secondary" id="btn-copy-ai">Copy Response</button>
      </div>
    </div>
  </div>

  <!-- RIGHT: Sidebar -->
  <aside class="sidebar">
    <div class="glass info-card">
      <h2>How It Works</h2>
      <ul class="info-list">
        <li>
          <span class="step-num">1</span>
          <span>Paste your text and click <strong>Analyze PII</strong></span>
        </li>
        <li>
          <span class="step-num">2</span>
          <span>Review detected PII by category. High-confidence items are pre-selected.</span>
        </li>
        <li>
          <span class="step-num">3</span>
          <span>Choose <strong>Redact Only</strong> to copy redacted text, or <strong>Send to AI</strong> to chat with an AI using your redacted content.</span>
        </li>
      </ul>

      <hr class="info-divider">

      <div class="info-features">
        <span class="feature-tag">Regex + NER</span>
        <span class="feature-tag">25+ PII Types</span>
        <span class="feature-tag">Confidence Scoring</span>
        <span class="feature-tag">Category Toggles</span>
        <span class="feature-tag">GPT-4 / Claude / Gemini</span>
      </div>
    </div>
  </aside>

</div>

<!-- AI Modal -->
<div class="modal" id="ai-modal">
  <div class="glass modal-content">
    <h3>Send to AI</h3>

    <label for="ai-model">Select AI Model</label>
    <select id="ai-model">
      <option value="openai/gpt-4o-mini">GPT-4o Mini (Fast)</option>
      <option value="openai/gpt-4o">GPT-4o (Best)</option>
      <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
      <option value="google/gemini-pro">Gemini Pro</option>
    </select>

    <label for="ai-prompt">Your Prompt</label>
    <textarea id="ai-prompt" placeholder="What would you like the AI to do with this text?&#10;&#10;Example: Summarize the main points of this document."></textarea>

    <details>
      <summary>Use your own API key (optional)</summary>
      <input type="password" id="user-api-key" placeholder="OpenRouter API key">
    </details>

    <div class="btn-row">
      <button class="btn-success" id="btn-submit-ai">Send</button>
      <button class="btn-secondary" id="btn-cancel-ai">Cancel</button>
    </div>
  </div>
</div>

<!-- Upload Choice Modal -->
<div class="modal" id="upload-choice-modal">
  <div class="glass modal-content">
    <h3>Text Already Exists</h3>
    <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5rem; font-size: 0.9rem;">
      The text area already contains content. What would you like to do?
    </p>
    <div class="btn-row" style="flex-direction: column; gap: 0.75rem;">
      <button class="btn-primary" id="btn-upload-replace">Replace with file content</button>
      <button class="btn-secondary" id="btn-upload-append">Append file content</button>
      <button class="btn-secondary" id="btn-upload-cancel">Cancel upload</button>
    </div>
  </div>
</div>

<!-- Toast notification -->
<div class="toast" id="toast"></div>

<footer>
  PrivaSend &mdash; Privacy-First PII Detection & Redaction
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// State Management
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const state = {
  text: '',
  entities: [],
  categories: {},
  categoryOrder: [],
  highConfidenceIndices: [],
  selected: new Set(),
  prefs: {},
  redactedText: '',
  mapping: {},
};

// Load preferences from localStorage
function loadPreferences() {
  try {
    const saved = localStorage.getItem('privasend_prefs');
    if (saved) state.prefs = JSON.parse(saved);
  } catch (e) {
    state.prefs = {};
  }
}

function savePreferences() {
  if (document.getElementById('persist-prefs').checked) {
    localStorage.setItem('privasend_prefs', JSON.stringify(state.prefs));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function showError(msg) {
  const el = document.getElementById('error-msg');
  el.textContent = msg;
  el.classList.add('visible');
}

function hideError() {
  document.getElementById('error-msg').classList.remove('visible');
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('visible');
  setTimeout(() => toast.classList.remove('visible'), 2500);
}

function setLoading(btn, loading, text) {
  btn.disabled = loading;
  btn.innerHTML = loading ? `<span class="spinner"></span>${text}` : text;
}

// PII type to CSS class
const PII_CLASSES = ['EMAIL','PHONE','SSN','CREDIT_CARD','PERSON','ADDRESS','ORGANIZATION','LOCATION','API_KEY','CREDENTIAL'];
function piiClass(type) {
  return PII_CLASSES.includes(type) ? `pii-${type}` : 'pii-default';
}

// Get category for a PII type (server provides this, but fallback)
function getCategory(piiType) {
  for (const [cat, indices] of Object.entries(state.categories)) {
    for (const idx of indices) {
      if (state.entities[idx]?.pii_type === piiType) return cat;
    }
  }
  return 'Other';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Core Functions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function handleAnalyze() {
  const text = document.getElementById('input-text').value.trim();
  if (!text) {
    showError('Please enter some text.');
    return;
  }
  hideError();
  state.text = text;

  const btn = document.getElementById('btn-analyze');
  setLoading(btn, true, 'Analyzing...');

  try {
    const res = await apiFetch('/api/analyze-for-review', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text }),
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.detail || `Server error (${res.status})`);
    }

    const data = await res.json();
    state.entities = data.entities;
    state.categories = data.categories;
    state.categoryOrder = data.category_order;
    state.highConfidenceIndices = data.high_confidence_indices;

    applyDefaults();
    renderReviewPanel();

    document.getElementById('review-panel').classList.add('visible');
    document.getElementById('results-panel').classList.remove('visible');
    document.getElementById('ai-response-panel').classList.remove('visible');

  } catch (e) {
    showError(e.message || 'Something went wrong.');
  } finally {
    setLoading(btn, false, 'Analyze PII');
  }
}

function applyDefaults() {
  state.selected.clear();

  // Pre-select high-confidence entities
  for (const idx of state.highConfidenceIndices) {
    state.selected.add(idx);
  }

  // Apply saved category preferences
  for (const [cat, enabled] of Object.entries(state.prefs)) {
    if (state.categories[cat]) {
      for (const idx of state.categories[cat]) {
        if (enabled) {
          // If pref says enabled, add medium confidence too
          if (state.entities[idx].confidence >= 0.50) {
            state.selected.add(idx);
          }
        } else {
          // If pref says disabled, remove all
          state.selected.delete(idx);
        }
      }
    }
  }
}

function renderReviewPanel() {
  const container = document.getElementById('categories-container');
  container.innerHTML = '';

  for (const cat of state.categoryOrder) {
    const indices = state.categories[cat];
    if (!indices || indices.length === 0) continue;

    const section = document.createElement('div');
    section.className = 'category-section';

    // Determine overall confidence level for category
    const hasHigh = indices.some(i => state.entities[i].confidence >= 0.85);
    const hasMedium = indices.some(i => state.entities[i].confidence >= 0.50 && state.entities[i].confidence < 0.85);
    let confLevel = 'medium';
    if (hasHigh && hasMedium) confLevel = 'mixed';
    else if (hasHigh) confLevel = 'high';

    // Count selected
    const selectedCount = indices.filter(i => state.selected.has(i)).length;
    const allSelected = selectedCount === indices.length;

    section.innerHTML = `
      <div class="category-header">
        <input type="checkbox" id="cat-${cat}" ${allSelected ? 'checked' : ''} data-cat="${cat}">
        <span class="cat-name">${cat}</span>
        <span class="cat-count">${selectedCount}/${indices.length}</span>
        <span class="confidence-indicator ${confLevel}">${confLevel.toUpperCase()}</span>
      </div>
      <div class="entity-list" id="entities-${cat}"></div>
    `;

    const entityList = section.querySelector('.entity-list');
    for (const idx of indices) {
      const e = state.entities[idx];
      const conf = e.confidence >= 0.85 ? 'high' : 'medium';
      const checked = state.selected.has(idx) ? 'checked' : '';

      const item = document.createElement('div');
      item.className = `entity-item ${conf}`;
      item.innerHTML = `
        <input type="checkbox" ${checked} data-idx="${idx}">
        <span class="entity-value">${escapeHtml(e.value)}</span>
        <span class="entity-meta">${e.pii_type} | ${(e.confidence * 100).toFixed(0)}%</span>
      `;
      entityList.appendChild(item);
    }

    container.appendChild(section);
  }

  // Add event listeners
  container.querySelectorAll('.category-header input').forEach(cb => {
    cb.addEventListener('change', (e) => toggleCategory(e.target.dataset.cat, e.target.checked));
  });
  container.querySelectorAll('.entity-item input').forEach(cb => {
    cb.addEventListener('change', (e) => toggleEntity(parseInt(e.target.dataset.idx), e.target.checked));
  });
}

function toggleCategory(cat, checked) {
  const indices = state.categories[cat] || [];
  for (const idx of indices) {
    if (checked) state.selected.add(idx);
    else state.selected.delete(idx);
  }
  state.prefs[cat] = checked;
  savePreferences();
  renderReviewPanel();
}

function toggleEntity(idx, checked) {
  if (checked) state.selected.add(idx);
  else state.selected.delete(idx);
  renderReviewPanel();
}

function resetPreferences() {
  state.prefs = {};
  localStorage.removeItem('privasend_prefs');
  document.getElementById('persist-prefs').checked = false;
  applyDefaults();
  renderReviewPanel();
  showToast('Preferences reset to defaults');
}

async function handleRedactOnly() {
  if (state.selected.size === 0) {
    showError('Please select at least one item to redact.');
    return;
  }
  hideError();

  const btn = document.getElementById('btn-redact-only');
  setLoading(btn, true, 'Redacting...');

  try {
    const res = await apiFetch('/api/redact-selected', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text: state.text,
        selected_indices: [...state.selected],
      }),
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.detail || `Server error (${res.status})`);
    }

    const data = await res.json();
    state.redactedText = data.redacted_text;
    state.mapping = data.mapping;

    renderResults(data);

    // Copy to clipboard
    await navigator.clipboard.writeText(data.redacted_text);
    showToast('Redacted text copied to clipboard!');

  } catch (e) {
    showError(e.message || 'Something went wrong.');
  } finally {
    setLoading(btn, false, 'Redact Only');
  }
}

function renderResults(data) {
  document.getElementById('stat-count').textContent = data.entity_count;
  document.getElementById('stat-time').textContent = Math.round(data.elapsed_ms);

  // Redacted text with colored tags
  let html = escapeHtml(data.redacted_text);
  html = html.replace(/\[([A-Z_]+)_(\d+)\]/g, (match, type) => {
    const cls = piiClass(type);
    return `<span class="pii-tag ${cls}">${match}</span>`;
  });
  document.getElementById('redacted-output').innerHTML = html;

  document.getElementById('review-panel').classList.remove('visible');
  document.getElementById('results-panel').classList.add('visible');
}

function openAIModal() {
  if (state.selected.size === 0) {
    showError('Please select at least one item to redact before sending to AI.');
    return;
  }
  hideError();
  document.getElementById('ai-modal').classList.add('visible');
}

function closeAIModal() {
  document.getElementById('ai-modal').classList.remove('visible');
}

async function handleSendToAI() {
  const model = document.getElementById('ai-model').value;
  const prompt = document.getElementById('ai-prompt').value.trim();
  const apiKey = document.getElementById('user-api-key').value.trim() || null;

  if (!prompt) {
    alert('Please enter a prompt.');
    return;
  }

  closeAIModal();

  const btn = document.getElementById('btn-send-ai');
  setLoading(btn, true, 'Sending...');

  try {
    const res = await apiFetch('/api/send-to-ai', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text: state.text,
        selected_indices: [...state.selected],
        model,
        prompt,
        api_key: apiKey,
      }),
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.detail || `Server error (${res.status})`);
    }

    const data = await res.json();

    // Show redacted output
    state.redactedText = data.redacted_input;
    document.getElementById('stat-count').textContent = state.selected.size;
    document.getElementById('stat-time').textContent = Math.round(data.elapsed_ms);

    let html = escapeHtml(data.redacted_input);
    html = html.replace(/\[([A-Z_]+)_(\d+)\]/g, (match, type) => {
      const cls = piiClass(type);
      return `<span class="pii-tag ${cls}">${match}</span>`;
    });
    document.getElementById('redacted-output').innerHTML = html;

    // Show AI response
    document.getElementById('ai-response-content').textContent = data.ai_response;

    document.getElementById('review-panel').classList.remove('visible');
    document.getElementById('results-panel').classList.add('visible');
    document.getElementById('ai-response-panel').classList.add('visible');

    showToast('AI response received!');

  } catch (e) {
    showError(e.message || 'Something went wrong.');
  } finally {
    setLoading(btn, false, 'Send to AI');
  }
}

function handleClear() {
  document.getElementById('input-text').value = '';
  document.getElementById('review-panel').classList.remove('visible');
  document.getElementById('results-panel').classList.remove('visible');
  document.getElementById('ai-response-panel').classList.remove('visible');
  hideError();
  state.text = '';
  state.entities = [];
  state.selected.clear();
  document.getElementById('input-text').focus();
}

function handleStartOver() {
  document.getElementById('review-panel').classList.remove('visible');
  document.getElementById('results-panel').classList.remove('visible');
  document.getElementById('ai-response-panel').classList.remove('visible');
  document.getElementById('input-text').focus();
}

async function copyToClipboard(text, msg) {
  try {
    await navigator.clipboard.writeText(text);
    showToast(msg);
  } catch (e) {
    showError('Failed to copy to clipboard');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// File Upload
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let pendingUploadFile = null;
let pendingUploadData = null;

function openUploadChoiceModal(file) {
  pendingUploadFile = file;
  document.getElementById('upload-choice-modal').classList.add('visible');
}

function closeUploadChoiceModal() {
  document.getElementById('upload-choice-modal').classList.remove('visible');
  pendingUploadFile = null;
  pendingUploadData = null;
}

function handleUploadReplace() {
  if (pendingUploadData) {
    document.getElementById('input-text').value = pendingUploadData.text;
    document.getElementById('file-name').textContent = 'âœ“ ' + pendingUploadFile.name + ' (' + pendingUploadData.char_count + ' chars, replaced)';
    showToast('File content replaced existing text. ' + pendingUploadData.char_count + ' characters.');
  }
  closeUploadChoiceModal();
}

function handleUploadAppend() {
  if (pendingUploadData) {
    const existingText = document.getElementById('input-text').value;
    const separator = existingText ? '\n\n--- File Content ---\n\n' : '';
    document.getElementById('input-text').value = existingText + separator + pendingUploadData.text;
    document.getElementById('file-name').textContent = 'âœ“ ' + pendingUploadFile.name + ' (' + pendingUploadData.char_count + ' chars, appended)';
    showToast('File content appended. ' + pendingUploadData.char_count + ' characters added.');
  }
  closeUploadChoiceModal();
}

async function handleFileUpload(file) {
  if (!file) return;

  const maxSize = 10 * 1024 * 1024; // 10MB
  if (file.size > maxSize) {
    showError('File too large. Max size: 10MB');
    return;
  }

  const btn = document.getElementById('btn-upload');
  const analyzeBtn = document.getElementById('btn-analyze');
  const originalText = btn.textContent;
  const existingText = document.getElementById('input-text').value.trim();

  // Disable buttons and show loading
  btn.textContent = 'â³ Extracting...';
  btn.disabled = true;
  analyzeBtn.disabled = true;
  analyzeBtn.textContent = 'Wait...';
  document.getElementById('file-name').textContent = 'ðŸ“„ ' + file.name + ' (processing...)';
  hideError();

  try {
    const formData = new FormData();
    formData.append('file', file);

    const res = await apiFetch('/api/upload', {
      method: 'POST',
      body: formData,
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.detail || 'Upload failed (' + res.status + ')');
    }

    const data = await res.json();

    if (data.text) {
      if (existingText) {
        // Text exists - show choice modal
        pendingUploadData = data;
        openUploadChoiceModal(file);
      } else {
        // Empty textarea - just insert
        document.getElementById('input-text').value = data.text;
        document.getElementById('file-name').textContent = 'âœ“ ' + file.name + ' (' + data.char_count + ' chars)';
        showToast('File ready! ' + data.char_count + ' characters extracted. Click "Analyze PII" to continue.');
      }
    } else if (data.warning) {
      showError(data.warning);
      document.getElementById('file-name').textContent = 'âš  ' + file.name;
    }
  } catch (e) {
    showError(e.message || 'Failed to upload file.');
    document.getElementById('file-name').textContent = 'âœ— ' + file.name;
  } finally {
    // Restore buttons
    btn.textContent = originalText;
    btn.disabled = false;
    analyzeBtn.disabled = false;
    analyzeBtn.textContent = 'Analyze PII';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Auth
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let authToken = localStorage.getItem('privasend_token');
let currentUser = null;

function openLoginModal() {
  document.getElementById('login-modal').classList.add('open');
}

function closeLoginModal() {
  document.getElementById('login-modal').classList.remove('open');
}

function switchTab(tab) {
  document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
  
  if (tab === 'login') {
    document.getElementById('tab-login').classList.add('active');
    document.getElementById('form-login').classList.add('active');
  } else {
    document.getElementById('tab-signup').classList.add('active');
    document.getElementById('form-signup').classList.add('active');
  }
}

async function handleLogin(e) {
  e.preventDefault();
  const email = document.getElementById('login-email').value;
  const password = document.getElementById('login-password').value;
  
  try {
    const res = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    
    const data = await res.json();
    
    if (data.success && data.access_token) {
      authToken = data.access_token;
      currentUser = data.user;
      localStorage.setItem('privasend_token', authToken);
      updateAuthUI();
      closeLoginModal();
      showToast('Welcome back, ' + data.user.email + '!');
    } else {
      showError(data.message || 'Login failed');
    }
  } catch (e) {
    showError('Login failed: ' + e.message);
  }
}

async function handleSignup(e) {
  e.preventDefault();
  const email = document.getElementById('signup-email').value;
  const password = document.getElementById('signup-password').value;
  
  try {
    const res = await fetch('/api/auth/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    
    const data = await res.json();
    
    if (data.success) {
      showToast(data.message || 'Signup successful! Please check your email.');
      switchTab('login');
    } else {
      showError(data.message || 'Signup failed');
    }
  } catch (e) {
    showError('Signup failed: ' + e.message);
  }
}

async function handleGoogleAuth() {
  try {
    const res = await fetch('/api/auth/google');
    const data = await res.json();
    
    if (data.url) {
      window.location.href = data.url;
    } else {
      showError('Failed to start Google login');
    }
  } catch (e) {
    showError('Google login failed: ' + e.message);
  }
}

async function handleLogout() {
  try {
    if (authToken) {
      await fetch('/api/auth/logout', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + authToken },
      });
    }
  } catch (e) {
    console.error('Logout error:', e);
  }
  
  authToken = null;
  currentUser = null;
  localStorage.removeItem('privasend_token');
  updateAuthUI();
  showToast('Logged out successfully');
}

function updateAuthUI() {
  const authBar = document.getElementById('auth-bar');
  const userInfo = document.getElementById('user-info');
  const userEmail = document.getElementById('user-email');
  const btnLogin = document.getElementById('btn-login');
  const btnLogout = document.getElementById('btn-logout');
  const pageLayout = document.getElementById('page-layout');
  
  if (authToken && currentUser) {
    userInfo.style.display = 'flex';
    userEmail.textContent = currentUser.email;
    btnLogin.style.display = 'none';
    btnLogout.style.display = 'block';
    pageLayout.classList.add('authenticated');
  } else {
    userInfo.style.display = 'none';
    btnLogin.style.display = 'block';
    btnLogout.style.display = 'none';
    pageLayout.classList.remove('authenticated');
    openLoginModal();
  }
}

async function checkAuth() {
  if (!authToken) {
    updateAuthUI();
    return;
  }
  
  try {
    const res = await fetch('/api/auth/me', {
      headers: { 'Authorization': 'Bearer ' + authToken },
    });
    
    if (res.ok) {
      const data = await res.json();
      if (data.success) {
        currentUser = data.user;
        updateAuthUI();
        return;
      }
    }
    
    // Token invalid
    authToken = null;
    localStorage.removeItem('privasend_token');
    updateAuthUI();
  } catch (e) {
    console.error('Auth check failed:', e);
    updateAuthUI();
  }
}

// Helper to add auth header to fetch requests
async function apiFetch(url, options = {}) {
  if (!authToken) {
    throw new Error('Not authenticated');
  }
  
  options.headers = options.headers || {};
  options.headers['Authorization'] = 'Bearer ' + authToken;
  
  return fetch(url, options);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Event Listeners
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.addEventListener('DOMContentLoaded', () => {
  checkAuth();
  loadPreferences();

  document.getElementById('btn-analyze').addEventListener('click', handleAnalyze);
  document.getElementById('btn-clear').addEventListener('click', handleClear);
  document.getElementById('btn-redact-only').addEventListener('click', handleRedactOnly);
  document.getElementById('btn-send-ai').addEventListener('click', openAIModal);
  document.getElementById('btn-reset-prefs').addEventListener('click', resetPreferences);

  document.getElementById('btn-submit-ai').addEventListener('click', handleSendToAI);
  document.getElementById('btn-cancel-ai').addEventListener('click', closeAIModal);

  document.getElementById('btn-copy').addEventListener('click', () => {
    copyToClipboard(state.redactedText, 'Copied to clipboard!');
  });
  document.getElementById('btn-new').addEventListener('click', handleStartOver);
  document.getElementById('btn-copy-ai').addEventListener('click', () => {
    const text = document.getElementById('ai-response-content').textContent;
    copyToClipboard(text, 'AI response copied!');
  });

  // File upload listeners
  const fileInput = document.getElementById('file-input');
  const uploadBtn = document.getElementById('btn-upload');

  uploadBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => {
    if (e.target.files && e.target.files[0]) {
      handleFileUpload(e.target.files[0]);
    }
  });

  // Upload choice modal listeners
  document.getElementById('btn-upload-replace').addEventListener('click', handleUploadReplace);
  document.getElementById('btn-upload-append').addEventListener('click', handleUploadAppend);
  document.getElementById('btn-upload-cancel').addEventListener('click', closeUploadChoiceModal);

  // Close modal on backdrop click
  document.getElementById('ai-modal').addEventListener('click', (e) => {
    if (e.target.id === 'ai-modal') closeAIModal();
  });

  // Ctrl+Enter to analyze
  document.getElementById('input-text').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) handleAnalyze();
  });
});
</script>
</body>
</html>
